# infra-mybilling/render.yaml
databases:
  - name: mybilling-pg
    plan: free
    region: frankfurt
    databaseName: mybilling
    user: mybilling

services:
  # --- WEB (Laravel) ---
  - name: mybilling-web
    type: web
    plan: free
    region: frankfurt
    runtime: docker
    repo: https://github.com/Mrrll/MyBilling.git
    branch: master
    dockerfilePath: laravel/Dockerfile
    autoDeploy: true
    healthCheckPath: /healthz
    envVarGroups:
      - mybilling-prod
    dockerCommand: >-
      bash -lc "mkdir -p storage/framework/{cache,sessions,views} bootstrap/cache &&
                php artisan config:cache || true &&
                php -S 0.0.0.0:$PORT -t public"

  # --- REVERB (WebSockets) ---
  - name: mybilling-reverb
    type: web                  # en Free no hay worker privado; lo exponemos con /healthz
    plan: free
    region: frankfurt
    runtime: docker
    repo: https://github.com/Mrrll/MyBilling.git
    branch: master
    dockerfilePath: laravel/Dockerfile
    autoDeploy: true
    healthCheckPath: /healthz
    envVarGroups:
      - mybilling-prod
    dockerCommand: >-
      bash -lc "mkdir -p storage/framework/{cache,sessions,views} bootstrap/cache &&
                php artisan config:cache || true &&
                php artisan reverb:start --host 0.0.0.0 --port $PORT"

  # --- QUEUE (database driver) ---
  - name: mybilling-queue
    type: web                  # usamos web para poder tener health check en Free
    plan: free
    region: frankfurt
    runtime: docker
    repo: https://github.com/Mrrll/MyBilling.git
    branch: master
    dockerfilePath: laravel/Dockerfile
    autoDeploy: true
    healthCheckPath: /healthz
    envVarGroups:
      - mybilling-prod
    dockerCommand: >-
      bash -lc "bash laravel/render-start-queue.sh"

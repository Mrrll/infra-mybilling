databases:
  - name: mybilling-pg
    databaseName: mybilling
    user: mybilling
    plan: free
    region: frankfurt

services:
  # ───────────────── MyBilling: Web ─────────────────
  - name: mybilling-web
    type: web
    runtime: docker
    plan: free
    region: frankfurt
    repo: https://github.com/Mrrll/MyBilling.git
    branch: master
    dockerfilePath: laravel/Dockerfile
    envVars:
      - { key: APP_ENV, value: production }
      - { key: APP_DEBUG, value: 'false' }
      - { key: APP_URL, value: https://<RELLENAR_MYBILLING_WEB>.onrender.com }
      # APP_KEY válida para primer deploy (misma en web/reverb/queue).
      - { key: APP_KEY, value: base64:Ww8g4M+0j3s8m2sHh1ZkQ1m2Yz6GQ2Jm1xZKp3d7i9Q= }
      - { key: QUEUE_CONNECTION, value: database }
      - { key: BROADCAST_CONNECTION, value: reverb }
      - { key: REVERB_CLIENT_HOST, value: https://<RELLENAR_MYBILLING_REVERB>.onrender.com }
      - { key: REVERB_CLIENT_SCHEME, value: https }
      - { key: REVERB_CLIENT_PORT, value: '' }
      - { key: DB_CONNECTION, value: pgsql }
      - key: DB_HOST
        fromDatabase: { name: mybilling-pg, property: host }
      - key: DB_PORT
        fromDatabase: { name: mybilling-pg, property: port }
      - key: DB_DATABASE
        fromDatabase: { name: mybilling-pg, property: database }
      - key: DB_USERNAME
        fromDatabase: { name: mybilling-pg, property: user }
      - key: DB_PASSWORD
        fromDatabase: { name: mybilling-pg, property: password }
    healthCheckPath: /healthz
    autoDeploy: true

  # ──────────────── MyBilling: Reverb (WSS) ────────────────
  - name: mybilling-reverb
    type: web
    runtime: docker
    plan: free
    region: frankfurt
    repo: https://github.com/Mrrll/MyBilling.git
    branch: master
    dockerfilePath: laravel/Dockerfile
    # En runtime docker se usa dockerCommand (no startCommand)
    dockerCommand: php artisan reverb:start --host 0.0.0.0 --port $PORT
    envVars:
      - { key: APP_ENV, value: production }
      - { key: APP_DEBUG, value: 'false' }
      - { key: APP_URL, value: https://<RELLENAR_MYBILLING_WEB>.onrender.com }
      # Misma APP_KEY que web/queue
      - { key: APP_KEY, value: base64:Ww8g4M+0j3s8m2sHh1ZkQ1m2Yz6GQ2Jm1xZKp3d7i9Q= }
      - { key: QUEUE_CONNECTION, value: database }
      - { key: BROADCAST_CONNECTION, value: reverb }
      - { key: REVERB_CLIENT_HOST, value: https://<RELLENAR_MYBILLING_REVERB>.onrender.com }
      - { key: REVERB_CLIENT_SCHEME, value: https }
      - { key: REVERB_CLIENT_PORT, value: '' }
      - { key: DB_CONNECTION, value: pgsql }
      - key: DB_HOST
        fromDatabase: { name: mybilling-pg, property: host }
      - key: DB_PORT
        fromDatabase: { name: mybilling-pg, property: port }
      - key: DB_DATABASE
        fromDatabase: { name: mybilling-pg, property: database }
      - key: DB_USERNAME
        fromDatabase: { name: mybilling-pg, property: user }
      - key: DB_PASSWORD
        fromDatabase: { name: mybilling-pg, property: password }
    # Reverb responde al handshake en /
    healthCheckPath: /
    autoDeploy: true

  # ──────────────── MyBilling: Queue (como web service Free) ────────────────
  - name: mybilling-queue
    type: web
    runtime: docker
    plan: free
    region: frankfurt
    repo: https://github.com/Mrrll/MyBilling.git
    branch: master
    dockerfilePath: laravel/Dockerfile
    # Levantamos un mini server para healthcheck y el worker en paralelo
    dockerCommand: >
      sh -c "php -S 0.0.0.0:$PORT -t public &
             php artisan queue:work --tries=1 --sleep=1 --backoff=3"
    envVars:
      - { key: APP_ENV, value: production }
      - { key: APP_DEBUG, value: 'false' }
      - { key: APP_URL, value: https://<RELLENAR_MYBILLING_WEB>.onrender.com }
      # Misma APP_KEY que web/reverb
      - { key: APP_KEY, value: base64:Ww8g4M+0j3s8m2sHh1ZkQ1m2Yz6GQ2Jm1xZKp3d7i9Q= }
      - { key: QUEUE_CONNECTION, value: database }
      - { key: BROADCAST_CONNECTION, value: reverb }
      - { key: DB_CONNECTION, value: pgsql }
      - key: DB_HOST
        fromDatabase: { name: mybilling-pg, property: host }
      - key: DB_PORT
        fromDatabase: { name: mybilling-pg, property: port }
      - key: DB_DATABASE
        fromDatabase: { name: mybilling-pg, property: database }
      - key: DB_USERNAME
        fromDatabase: { name: mybilling-pg, property: user }
      - key: DB_PASSWORD
        fromDatabase: { name: mybilling-pg, property: password }
    healthCheckPath: /healthz
    autoDeploy: true
